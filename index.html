<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Dutch Helper</title>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#7dd3fc; --glass: rgba(255,255,255,0.03);
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Helvetica,Arial;}
body{background:linear-gradient(180deg,#071029 0%, #061226 100%); color:#e6eef6; -webkit-font-smoothing:antialiased;}
.wrap{max-width:980px;margin:18px auto;padding:14px;}
header{display:flex;gap:10px;align-items:center;margin-bottom:12px;}
h1{font-size:18px;margin:0}
.searchbox{display:flex;gap:8px;width:100%;}
input[type="search"]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:inherit;font-size:16px;outline:none}
button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#60a5fa);color:#032; font-weight:600;cursor:pointer}
.row{display:flex;gap:12px;flex-wrap:wrap}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);flex:1;min-width:240px;}
.panel h2{margin:0 0 8px 0;font-size:14px;color:var(--accent)}
small.muted{color:var(--muted);display:block;margin-bottom:8px}
pre{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;background:transparent;margin:0;padding:6px 0;color:#cfeffd}
footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
.spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}
.chip{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);margin-right:6px;font-size:13px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="flex:1">
      <h1>Dutch Helper</h1>
      <small class="muted">Dutch → English → 简体中文 · Wiktionary + Google Translate · auto language detection</small>
    </div>
  </header>

  <div class="searchbox">
    <input id="q" type="search" placeholder="Type a Dutch word (e.g. leraar, lopen, mooi) or EN word" autofocus />
    <button id="go">Lookup</button>
    <button id="clear" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">Clear</button>
  </div>

  <div class="row" style="margin-top:12px">
    <div class="panel" style="flex-basis:280px;">
      <h2>Pronunciation</h2>
      <div id="pron">IPA / audio will appear here.</div>
      <div id="audioWrap" style="margin-top:6px;"></div>
      <div style="margin-top:10px">
        <span id="openW" class="chip">Open in Wiktionary</span>
        <span id="copyAll" class="chip">Copy as Markdown</span>
      </div>
    </div>

    <div class="panel">
      <h2>Definitions</h2>
      <div id="definitions"><small class="muted">No data yet.</small></div>
    </div>

    <div class="panel">
      <h2>Inflections</h2>
      <div id="inflections"><small class="muted">No data yet.</small></div>
    </div>

    <div class="panel">
      <h2>Examples</h2>
      <div id="examples"><small class="muted">No data yet.</small></div>
    </div>

    <div class="panel">
      <h2>Chinese</h2>
      <div id="chinese"><small class="muted">No data yet.</small></div>
    </div>
  </div>

  <footer>
    If some words don’t show full data, it’s because Wiktionary pages are not uniform. You can adjust parsing later.
  </footer>
</div>

<script>
// ========== helpers ==========
const qIn = document.getElementById('q');
const goBtn = document.getElementById('go');
const clearBtn = document.getElementById('clear');
const pronDiv = document.getElementById('pron');
const audioWrap = document.getElementById('audioWrap');
const defsDiv = document.getElementById('definitions');
const inflDiv = document.getElementById('inflections');
const exDiv = document.getElementById('examples');
const zhDiv = document.getElementById('chinese');
const openW = document.getElementById('openW');
const copyAll = document.getElementById('copyAll');

let lastResult = null;

function setLoading(msg){
  defsDiv.innerHTML = `<span class="spinner"></span> ${msg}`;
  inflDiv.innerHTML = `<span class="spinner"></span> ${msg}`;
  exDiv.innerHTML = `<span class="spinner"></span> ${msg}`;
  zhDiv.innerHTML = `<span class="spinner"></span> ${msg}`;
  pronDiv.innerHTML = `<span class="spinner"></span> ${msg}`;
}

function safeText(html){
  const d = new DOMParser().parseFromString(html || '', 'text/html');
  return d.body.textContent || '';
}

// ========== 1. detect language via google ==========
async function detectLang(text){
  if(!text) return 'und';
  const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=en&dt=tl&q=' + encodeURIComponent(text);
  try{
    const r = await fetch(url);
    const j = await r.json();
    const lang = (Array.isArray(j) && (j[2] || (j[8] && j[8][0] && j[8][0][0]))) ? (j[2] || (j[8] && j[8][0] && j[8][0][0])) : 'und';
    return lang;
  }catch(e){
    return 'und';
  }
}

// ========== 2. fetch wiktionary ==========
async function fetchWiktionary(word, langGuess){
  // prefer nl, fallback en
  const order = (langGuess === 'nl')
    ? ['nl.wiktionary.org','en.wiktionary.org']
    : (langGuess.startsWith('en')
        ? ['en.wiktionary.org','nl.wiktionary.org']
        : ['nl.wiktionary.org','en.wiktionary.org']
      );

  for(const host of order){
    const url = `https://${host}/w/api.php?action=parse&page=${encodeURIComponent(word)}&prop=text|sections&format=json&origin=*`;
    try{
      const r = await fetch(url);
      const j = await r.json();
      if(j.parse && j.parse.text && j.parse.text['*']){
        return {host, html:j.parse.text['*']};
      }
    }catch(e){
      // try next
    }
  }
  return null;
}

// ========== 3. parse wiktionary html ==========
function parseWk(html, host){
  const doc = new DOMParser().parseFromString(html,'text/html');
  const res = {
    ipa: null,
    audio: null,
    definitions: [],
    examples: [],
    inflections: [],
    pos: []
  };

  // IPA
  const ipaEl = doc.querySelector('.IPA, .ipa');
  if(ipaEl) res.ipa = ipaEl.textContent.trim();

  // audio
  const audioEl = doc.querySelector('audio source, audio');
  if(audioEl){
    res.audio = audioEl.src || audioEl.getAttribute('src');
    if(res.audio && res.audio.startsWith('/')) {
      res.audio = 'https://' + host + res.audio;
    }
  } else {
    const fileLink = doc.querySelector('a[href*="/wiki/Bestand:"], a[href*="/wiki/File:"]');
    if(fileLink) res.audio = fileLink.href;
  }

  // definitions
  const firstList = doc.querySelector('ol, ul');
  if(firstList){
    const lis = firstList.querySelectorAll('li');
    lis.forEach(li=>{
      const txt = safeText(li.innerHTML).trim();
      if(txt) res.definitions.push(txt);
    });
  }

  // examples (very rough)
  const allLis = doc.querySelectorAll('li');
  allLis.forEach(li=>{
    const t = li.textContent.trim();
    if(/voorbeeld|example|bijv\.|bv\./i.test(t)) {
      res.examples.push(t);
    }
  });

  // inflections: any table
  const tab = doc.querySelector('table');
  if(tab){
    res.inflections.push(safeText(tab.innerHTML));
  }

  // pos from headings
  doc.querySelectorAll('h2, h3, h4').forEach(h=>{
    const t = h.textContent.trim();
    if(/werkwoord|zelfstandig naamwoord|bijvoeglijk naamwoord|verb|noun|adjective/i.test(t)){
      res.pos.push(t);
    }
  });

  return res;
}

// ========== 4. translate via google ==========
async function translate(text, target){
  if(!text) return '';
  const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=' + target + '&dt=t&q=' + encodeURIComponent(text.slice(0,1500));
  try{
    const r = await fetch(url);
    const j = await r.json();
    if(Array.isArray(j) && Array.isArray(j[0])){
      return j[0].map(p=>p[0]).join('');
    }
  }catch(e){}
  return '';
}

// ========== 5. main lookup ==========
async function doLookup(){
  const word = qIn.value.trim();
  if(!word) return;
  setLoading('Looking up…');

  const lang = await detectLang(word);
  const wk = await fetchWiktionary(word, lang);
  if(!wk){
    defsDiv.innerHTML = '<small class="muted">No Wiktionary entry found.</small>';
    return;
  }
  const parsed = parseWk(wk.html, wk.host);

  // translate definitions & examples
  const defsText = parsed.definitions.join('\n\n') || word;
  const exText = parsed.examples.join('\n') || '';
  const [defsEn, defsZh, exEn, exZh] = await Promise.all([
    translate(defsText, 'en'),
    translate(defsText, 'zh-CN'),
    translate(exText, 'en'),
    translate(exText, 'zh-CN'),
  ]);

  // render
  // pronunciation
  pronDiv.innerHTML = '';
  if(parsed.ipa){
    pronDiv.innerHTML += `<div><strong>IPA:</strong> ${parsed.ipa}</div>`;
  }
  if(parsed.pos && parsed.pos.length){
    pronDiv.innerHTML += `<div style="margin-top:4px"><strong>POS:</strong> ${parsed.pos.join(', ')}</div>`;
  }
  if(!parsed.ipa && (!parsed.pos || !parsed.pos.length)){
    pronDiv.innerHTML = '<small class="muted">No pronunciation info found.</small>';
  }

  audioWrap.innerHTML = '';
  if(parsed.audio){
    const a = document.createElement('audio');
    a.controls = true;
    a.src = parsed.audio;
    a.style.width = '100%';
    audioWrap.appendChild(a);
  }

  // definitions
  defsDiv.innerHTML = '';
  if(parsed.definitions.length){
    parsed.definitions.slice(0,10).forEach((d,i)=>{
      const div = document.createElement('div');
      div.style.marginBottom = '6px';
      div.innerHTML = `<strong>${i+1}.</strong> ${d}`;
      defsDiv.appendChild(div);
    });
    // add EN
    if(defsEn){
      const enDiv = document.createElement('div');
      enDiv.innerHTML = `<small class="muted"><em>EN:</em> ${defsEn}</small>`;
      defsDiv.appendChild(enDiv);
    }
  } else {
    defsDiv.innerHTML = '<small class="muted">No definitions found.</small>';
  }

  // inflections
  inflDiv.innerHTML = '';
  if(parsed.inflections.length){
    parsed.inflections.forEach(i=>{
      const pre = document.createElement('pre');
      pre.textContent = i;
      inflDiv.appendChild(pre);
    });
  } else {
    inflDiv.innerHTML = '<small class="muted">No inflection data.</small>';
  }

  // examples
  exDiv.innerHTML = '';
  if(parsed.examples.length){
    const ul = document.createElement('ul');
    parsed.examples.slice(0,6).forEach(e=>{
      const li = document.createElement('li');
      li.textContent = e;
      ul.appendChild(li);
    });
    exDiv.appendChild(ul);
    if(exEn){
      const en = document.createElement('div');
      en.innerHTML = `<small class="muted"><em>EN:</em> ${exEn}</small>`;
      exDiv.appendChild(en);
    }
  } else {
    exDiv.innerHTML = '<small class="muted">No examples.</small>';
    if(exEn){
      const en = document.createElement('div');
      en.innerHTML = `<small class="muted"><em>EN (machine):</em> ${exEn}</small>`;
      exDiv.appendChild(en);
    }
  }

  // chinese
  zhDiv.innerHTML = '';
  if(defsZh){
    zhDiv.innerHTML = `<div>${defsZh}</div>`;
  } else {
    zhDiv.innerHTML = '<small class="muted">No Chinese translation.</small>';
  }

  // store for copy
  lastResult = {
    word,
    lang,
    host: wk.host,
    parsed,
    defsEn,
    defsZh,
    exEn,
    exZh
  };

  // open wiktionary btn
  openW.onclick = () => {
    const u = `https://${wk.host}/wiki/${encodeURIComponent(word)}`;
    window.open(u, '_blank');
  };
}

// ========== copy markdown ==========
copyAll.onclick = () => {
  if(!lastResult){
    alert('No data to copy.');
    return;
  }
  const r = lastResult;
  const lines = [];
  lines.push(`# ${r.word}`);
  lines.push(`Source: ${r.host}`);
  if(r.parsed.ipa) lines.push(`**IPA:** ${r.parsed.ipa}`);
  if(r.parsed.pos && r.parsed.pos.length) lines.push(`**POS:** ${r.parsed.pos.join(', ')}`);
  lines.push('\n## Definitions (original)');
  if(r.parsed.definitions.length) r.parsed.definitions.forEach((d,i)=>lines.push(`${i+1}. ${d}`));
  lines.push('\n## English (machine)');
  if(r.defsEn) lines.push(r.defsEn);
  lines.push('\n## Chinese (machine)');
  if(r.defsZh) lines.push(r.defsZh);
  lines.push('\n## Inflections');
  if(r.parsed.inflections.length) r.parsed.inflections.forEach(i=>lines.push(i));
  lines.push('\n## Examples');
  if(r.parsed.examples.length) r.parsed.examples.forEach(e=>lines.push(`- ${e}`));
  if(r.exEn) lines.push(`EN: ${r.exEn}`);
  if(r.exZh) lines.push(`ZH: ${r.exZh}`);

  const md = lines.join('\n');
  navigator.clipboard.writeText(md).then(()=>alert('Copied markdown')).catch(()=>alert('Copy failed'));
};

// ========== bind ==========
goBtn.addEventListener('click', doLookup);
qIn.addEventListener('keydown', e=>{ if(e.key==='Enter') doLookup(); });
clearBtn.addEventListener('click', ()=>{
  qIn.value = '';
  pronDiv.innerHTML = 'IPA / audio will appear here.';
  audioWrap.innerHTML = '';
  defsDiv.innerHTML = '<small class="muted">No data yet.</small>';
  inflDiv.innerHTML = '<small class="muted">No data yet.</small>';
  exDiv.innerHTML = '<small class="muted">No data yet.</small>';
  zhDiv.innerHTML = '<small class="muted">No data yet.</small>';
  lastResult = null;
});
</script>
</body>
</html>
